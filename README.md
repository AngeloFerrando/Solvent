# Solvent: liquidity verification of smart contracts

Solvent is a tool to formally verify liquidity properties of Solidity smart contracts. 

Liquidity expresses the ideal behaviour of contracts in terms of the exchange of crypto-assets: users want to be guaranteed that, whenever certain states are reached, they can always perform some actions that lead to a desirable asset transfer. While several real-world attacks to smart contracts exploited liquidity vulnerabilities, detecting such vulnerabilities is beyond the reach of current verification tools for Solidity. 

Details on Solvent and on the underlying verification technique in the following research paper:
- M. Bartoletti, A. Ferrando, E. Lipparini, V. Malvone: [Solvent: liquidity verification of smart contracts](https://arxiv.org/abs/2404.17864). iFM, 2024 
 
## Structure

The data in this repository is structured as follows:

- Subdirectory  [src](src) contains the source code of the tool;
- Subdirectory  [contracts](contracts) contains the benchmark of smart contracts and related liquidity properties that we used to evaluate the effectiveness of Solvent in our paper;
- Subdirectory  [results](results) contains the results of the experiments (they are discussed in the iFM paper).

## Getting Started 

### From the docker image

Download the [docker image](https://zenodo.org/records/13321024) from Zenodo. Then, load it from the .tar archive (docker may require sudo root privileges):
```
docker load < solvent.tar
```
Upon loading the image, run the container with:
```
docker run -v `pwd`/output:/tool/output --rm -it solvent
```
The command above starts the docker container and places you in a bash environment, where you can inspect the source code or run the experiments. -v option will mount output folder in your current directory to the corresponding folder within the container where the evaluation results will be stored. This will allow you to view the generated output even after the container has stopped running. --rm is an optional flag that creates a disposable container that will be deleted upon exit.
At this point, you can run the experiments as explained below.

You can exit the container by typing `exit`. Output files generated by the evaluation script (logs, tables, plots, etc.) remain available in $PWD/output. Upon finishing your review, you can remove the image from the Docker environment using:
```
docker rmi solvent
```

### From github

Solvent has the following depencies:
- [Python 3](https://www.python.org/)
- [Z3](https://github.com/Z3Prover/z3)
- [cvc5](https://cvc5.github.io/) 
- [pip](https://pypi.org/project/pip/)

To install them, run:
```bash
pip3 install -r requirements.txt
```

To check that everything is ok, clone the repository and run the regression tests:
```bash
python3 evaluate.py --solver cvc5 --only_regression --Timeout 5
```

## Reproducing the experiments

To run all the experiments (should take up to 2 hours), use:
```bash
python3 evaluate.py --solver z3 
```
This runs all the experiments using z3 as a backend. If you want instead to use cvc5, run:
```bash
python3 evaluate.py --solver cvc5 
```
If finished successfully, the evaluation script should print:
```
All experiments were successful.
```
To compare your results with those in the article, redirect the output of `evaluate.sh`. For instance:
```
python3 evaluate.py --solver z3 > z3.out
```

Then, to compare your results with those in the paper, run:
```bash
git diff --no-index --word-diff results/z3.out z3.out
```
to check that the logs are the same (up to timing differences).


## Verifying your own contracts

To use Solvent on your own contract, open a terminal and run the following:
```bash
python3 solvent.py <file.sol> <number of transactions> <solver> <timeout>?
```
where:
- `file.sol` is the smart contract
- `number of transactions` is the maximum number of transactions to consider in the bounded model checking problem
- `solver` is the solver to use (eg., z3 or cvc5)
- `timeout` (optional) is the maximum number of seconds the SMT solver can take to complete the verification


## Extending Solvent

To extend the Solidity fragment supported by Solvent, install [antlr4 (version 4.7.2)](https://www.antlr.org/).
Once this is done, run the following to compile the extended grammar:
```bash
antlr4 -Dlanguage=Python3 -visitor TxScript.g4 
```
